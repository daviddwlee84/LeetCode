from typing import List
import heapq
from collections import defaultdict, deque


class Solution:
    def assignTasks(self, servers: List[int], tasks: List[int]) -> List[int]:
        server_heap = [(weight, i) for i, weight in enumerate(servers)]
        heapq.heapify(server_heap)
        server_free = defaultdict(list)
        pending = deque()
        next_free_time = []

        ans = [None] * len(tasks)
        time = 0
        while time < len(tasks) or pending:
            duration = None
            if time < len(tasks):
                # release new tasks
                task_i = time
                duration = tasks[time]
                pending.append((duration, task_i))

            if server_free[time]:
                for i in server_free[time]:
                    weight = servers[i]
                    heapq.heappush(server_heap, (weight, i))
                del server_free[time]

            while server_heap and pending:
                duration, task_i = pending.popleft()
                _, server_i = heapq.heappop(server_heap)
                ans[task_i] = server_i
                server_free[time + duration].append(server_i)
                heapq.heappush(next_free_time, time + duration)

            if time < len(tasks):
                time += 1
                while next_free_time and time == next_free_time[0]:
                    heapq.heappop(next_free_time)
            else:
                time = heapq.heappop(next_free_time)

        return ans

# Basically the "next_free_time" issue
# WA (fixed)
# servers: [31,96,73,90,15,11,1,90,72,9,30,88]
# tasks: [87,10,3,5,76,74,38,64,16,64,93,95,60,79,54,26,30,44,64,71]
# output: [6,9,5,4,10,3,2,0,2,8,10,5,9,8,0,11,4,6,2,10]
# expect: [6,9,5,4,10,5,0,8,4,2,11,9,3,7,1,4,0,4,1,8]
# WA (fixed)
# [318,274,325,517,437,829,86,570,311,150,277,756,710,910,750,77,801,256,894,588,748,41,681,222,463,757,703,551,99,177,788,333,937,295,101,97,989,710,549,984,492,459,38,568,382,555,984,937,945,849,489,665,426,766,988,148,920,691,486,403,996,599,703,625,236,55,457,833,409,405,782,427,342,494,217,531,874,249,770,399,983,766,682,954,786,9,760,516,862,325,661,17,78,154,352,897,27,742,864,548,570,146,501,251,623,414,631,637,852,869,527,196,173,123,238,740,291,373,675,491,97,787,635,327,501,669,674,166,394,700,415,240,96,827,396,834,760,956,208,158,818,179,420,303,169,489,362,884,310,590,981,655,629,257,749,521,525,386,371,596,263,835,86,149,446,107,435,199,367,182,74,390,348,158,711,895,662,503,436,951,26,740,42,57,459,288,32,859,591,528,422,402,353,2,849,585,62,950,817,760,268,102]
# [224,724,777,12,261,105,48,816,272,228,779,332,312,802,463,239,907,673,752,587,271,615,152,871,714,109,640,999,830,212,670,486,110,909,720,389,638,445,898,639,945,918,524,776,286,791,344,659,636,963,550,480,119,33,906,36,981,648,257,435,603,97,375,705,325,177,928,506,378,976,326,109,800,195,514,453,699,730,492,644,720,5,887,87,736,693,426,288,797,69,454,870,38,270,571,834,351,799,39,466,145,531,463,276,590,463,958,335,706,840,619,975,597,68,766,338,148,244,315,11,881,782,79,855,246,585,1000,66,414,122,423,800,895,211,168,63,592,108,862,835,892,20,798,465,213,326,703,64,839,488,772,178,628,66,94,865,326,904,844,260,134,955,691,345,677,774,885,735,162,643,910,730,648,460,444,954,241,790,280,493,848,702,445,254,156,786,923,906,900,819,848,267,858,437,883,170,209,102,428,866,188,851,993,729,120,541,614,267,449,305,195,300,154,469,68,889,465,185,351,756,705,690,198,339,789,39,301,958,519,886,548,266,626,88,254,386,18,286,874,862,348,229,34,477,714,806,408,468,573,500,902,904,973,938,533,661,591,391,589,162,264,584,26,511,355,591,12,831,962,385,349,909,171,412,44,156,848,397,754,283,117,789,406,423,873,3,955,651,606,997,657,545,822,697,364,815,59,91,792,355,231,391,418,98,197,769,382,891,948,715,265,151,113,583,480,400,379,225,955,603,17,560,135,972,216,354,466,696,230,412,370,17,138,755,612,188,901,258,508,417,173,935,84,744,464,129,591,294,480,4,222,856,925,26,729,249,490,556,797,685,820,530,316,804,892,928,334,759,249,699,315,646,996,53,403,677,272,893,438,542,207,395,91,531,552,877,881,864,219,377,622,38,352,549,438,431,157,198,581,949,823,730,978,645,551,125,172,315,93,681,149,450,425,321,88,267,806,482,855,506,73,269,213,23,264,744,360,416,142,937,553,374,385,220,587,149,433,111,794,749,131,343,281,620,967,303,369,383,763,49,17,178,648,395,680,690,214,171,792,278,746,301,42,580,112,236,904,739,412,105,34,60,301,67,607,221,782,825,961,34,556,734,766,712,942,950,636,815,428,884,179,889,36,717,874,146,585,390,469,701,523,767,34,61,399,393,198,682,628,24,634,999,268,973,488,130,390,974,950,90,213,922,385,955,400,305,953,855,18,961,323,741,5,537,993,887,729,764,565,710,972,691,911,921,64,298,531,167,880,5,229,436,831,580,413,865,269,499,843,181,246,424,893,146,549,418,742,95,766,55,699,64,107,502,842,459,967,248,933,257,143,577,969,644,164,267,104,108,661,33,826,578,138,649,189,169,72,315,176,971,319,192,349,875,743,706,77,868,142,628,267,569,356,593,754,456,272,372,193,108,466,639,404,974,74,473,876,310,329,303,822,936,892,451,341,756,827,607,447,516,690,114,816,146,165,544,719,621,891,728,394,45,823,883,344,818,343,991,360,194,913,529,643,75,604,881,890,423,793,194,1000,745,32,740,141,348,101,579,597,590,371,320,632,17,501,776,503,769,984,964,951,148,514,669,120,41,33,470,356,800,580,817,479,389,246,964,576,459,48,746,913,238,871,144,30,720,215,991,775,354,287,83,557,462,202,59,227,389,318,277,530,692,859,691,706,947,384,410,550,481,407,217,658,301,12,462,13,975,864,466,508,314,707,968,566,73,252,669,361,143,165,325,501,277,310,766,146,420,798,675,822,933,444,165,719]
# [193,85,91,180,96,186,42,21,182,65,183,196,170,15,92,180,6,162,132,35,120,28,34,201,165,113,101,55,163,9,93,139,173,127,144,112,29,141,169,111,167,138,74,23,64,114,131,77,103,17,153,160,200,1,42,10,185,116,33,143,148,8,0,2,89,123,31,72,172,94,192,146,168,158,117,44,157,171,128,134,79,191,59,69,68,105,76,167,27,80,42,178,22,134,115,167,89,130,82,176,179,83,49,10,170,131,22,4,53,200,108,195,201,124,3,142,65,175,35,148,169,128,80,148,110,37,15,63,82,91,156,24,145,148,95,62,135,37,104,194,114,198,144,70,189,165,13,160,11,64,155,101,163,146,105,150,2,115,96,174,197,42,175,105,155,156,32,185,64,91,169,72,153,61,151,75,17,132,101,145,136,117,66,51,162,106,153,14,107,103,108,1,135,144,57,47,114,155,176,37,42,114,186,121,85,13,169,90,165,162,157,77,111,200,113,127,52,73,129,134,119,72,48,54,54,48,89,172,157,131,73,147,175,10,72,82,111,164,140,113,194,194,107,155,38,31,164,182,183,108,27,157,162,49,145,149,60,32,188,170,58,197,152,57,50,141,15,190,129,186,29,1,4,61,59,40,102,84,38,140,119,71,37,106,97,171,153,171,32,141,18,119,87,165,161,120,28,57,23,154,155,56,164,22,70,137,197,184,173,1,82,107,34,172,79,30,138,142,58,156,37,183,18,130,93,106,162,82,195,146,11,63,17,120,102,3,161,4,50,71,62,67,80,121,48,26,51,191,68,185,185,192,40,29,196,35,167,148,109,177,126,170,80,183,20,46,129,194,21,160,172,93,122,45,57,6,69,78,163,63,20,21,140,11,113,44,49,194,168,121,68,10,91,82,7,28,20,187,101,123,70,63,58,40,138,7,47,195,150,52,61,33,32,103,63,72,77,156,94,81,141,152,63,197,98,182,82,107,92,161,64,177,32,72,46,7,101,91,121,76,4,61,175,86,135,63,105,22,1,99,125,119,67,201,41,145,178,136,90,140,141,47,68,84,81,150,96,83,102,62,99,44,41,6,8,34,47,56,119,145,61,100,181,32,180,55,136,153,66,199,70,84,119,100,143,197,185,100,14,82,178,37,175,171,102,181,152,170,176,190,92,75,70,54,153,159,187,48,183,186,193,142,22,101,167,11,36,171,108,195,192,139,93,93,152,159,11,96,53,75,99,26,115,22,133,63,69,132,112,201,36,168,27,171,87,23,1,99,55,108,113,200,0,72,69,16,71,55,102,201,150,0,193,105,96,4,129,23,82,62,101,17,137,123,71,134,120,65,118,84,120,143,30,67,190,129,171,80,89,99,96,79,69,80,141,150,189,64,79,78,1,86,83,127,11,23,62,87,16,14,104,17,75,118,95,60,166,127,184,194,99,115,46,68,81,10,13,113,21,197,19,105,9,24,67,194,59,131,136,88,169,82,6,26,50,151,134,49,21,132,145,87,131,127,100,167,19,98,1,117,151,54,93,71,155,63,82,84,1,43,26,68,81,94,168,137,164,129,0,118,134,7,188,144,162,20,123,160,78,95,89,4,3,189,27,29,49,199,51,112,193,61,126,185,98,139,146,91,65,132,187,157,123,116,11,68,52,20,190,154,80,52,83,116,166,44,114,201,82,24,190,100,69,194,140,65,57,111,100,62,92,87,21,108,55,102,103,167,160,118,37,98,68,19,15,42,43,25,125,82,142,155,187,64,134]
# [193,85,91,180,96,186,42,21,182,65,183,196,170,15,92,180,6,162,132,35,120,28,34,201,165,113,101,55,163,9,93,139,173,127,144,112,29,141,169,111,167,138,74,23,64,114,131,77,103,17,153,160,200,1,42,10,185,116,33,143,148,8,0,2,89,123,31,72,172,94,192,146,168,158,117,44,157,171,128,134,79,191,59,69,68,105,1,191,130,142,190,10,52,71,166,178,4,164,66,41,184,24,58,50,145,119,40,73,102,124,186,177,87,3,155,156,110,189,75,99,38,27,45,43,7,100,195,19,149,188,52,99,159,61,113,104,63,66,152,106,122,107,173,151,90,176,51,125,126,118,22,82,57,129,26,62,12,37,8,142,174,107,115,181,97,20,154,14,11,25,69,200,86,136,34,199,53,81,78,70,146,3,84,121,30,16,198,140,133,5,67,135,161,19,49,194,108,187,104,88,98,45,109,76,147,18,175,95,13,56,32,125,47,48,197,179,83,137,150,129,80,39,46,54,193,36,60,65,9,123,66,184,26,188,180,110,36,96,158,182,197,36,120,174,187,113,33,170,147,120,82,64,11,188,30,196,61,90,189,71,194,47,7,191,50,98,89,131,192,7,89,137,108,32,53,142,46,112,75,0,121,73,172,4,156,78,135,53,78,176,95,92,141,12,143,180,181,184,125,36,1,56,139,71,60,44,160,149,190,96,52,121,54,41,58,74,181,119,150,128,72,142,108,117,72,153,184,35,151,34,71,104,84,194,19,197,24,136,28,118,104,110,13,148,166,101,70,29,54,111,83,111,48,103,162,145,93,116,121,77,87,103,100,108,0,33,134,60,85,63,186,50,165,13,1,18,90,89,144,9,84,2,132,174,157,105,91,57,7,183,170,66,119,13,101,79,72,171,25,102,15,104,32,52,197,23,68,86,175,112,21,120,66,114,151,97,51,172,115,163,143,132,36,4,168,30,26,155,3,130,191,136,4,201,164,147,200,14,27,83,56,39,160,175,22,6,80,151,178,143,99,76,139,61,169,20,173,127,145,23,181,99,124,189,47,153,138,42,10,72,74,81,29,59,16,21,84,85,106,129,43,98,143,167,126,124,68,71,31,74,7,152,38,8,196,171,5,129,17,193,14,187,90,62,92,3,55,100,159,81,146,34,122,59,56,185,38,67,186,94,58,147,161,154,81,45,90,118,134,37,47,40,88,78,72,184,88,134,49,36,69,62,177,133,140,179,113,97,198,76,53,127,201,76,107,195,123,166,199,132,95,94,142,86,168,182,158,28,119,1,41,171,173,54,114,140,2,183,185,128,7,12,75,93,153,144,21,160,65,109,1,171,131,23,55,6,109,79,73,82,101,64,26,28,103,19,99,39,66,58,173,116,70,136,96,46,29,120,97,188,4,86,80,155,21,44,122,109,35,9,160,174,125,11,141,151,132,137,7,180,156,99,157,61,200,172,53,13,153,45,192,131,163,197,21,10,95,50,194,188,47,77,25,6,123,66,129,179,131,148,73,55,135,183,170,3,162,92,31,18,64,38,63,128,149,161,191,99,135,128,81,144,52,176,97,6,61,17,164,60,190,200,112,121,61,6,108,162,56,150,173,87,107,189,24,175,43,14,111,29,79,104,127,101,170,94,182,117,24,56,16,188,139,26,110,97,5,148,78,9,144,48,109,0,169,140,30,94,70,169,68,166,104,20,30,35,15,113,49,89,57,141,120,33,83,105,159,51,54,91,146,189,168,178,181]
